<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Multi-Crypto Pro - OpenOcean API R√©elle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        .glow {
            animation: glow 2s ease-in-out infinite;
        }
        .telegram-gradient {
            background: linear-gradient(135deg, #0088cc, #00bcd4);
        }
        .openocean-gradient {
            background: linear-gradient(135deg, #00d4ff, #0088ff);
        }
        .arbitrage-gradient {
            background: linear-gradient(135deg, #10b981, #059669);
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Bot Trading Multi-Crypto Pro
                </h1>
                <p class="text-gray-400 mt-2">üåä OpenOcean API R√©elle ‚Ä¢ üíé Arbitrage Multi-DEX ‚Ä¢ Trading 24/7</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="openTelegramChannel()" class="flex items-center gap-2 px-4 py-3 telegram-gradient hover:opacity-90 rounded-lg font-semibold transition-all shadow-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                    </svg>
                    <span>Canal Telegram</span>
                    <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full pulse">LIVE</span>
                </button>
                
                <button onclick="openDCASwap()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-semibold transition-all">
                    <span>üîÑ</span>
                    DCA/Swap
                    <span>‚Üó</span>
                </button>
                
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                    <span>üëõ</span>
                    <span id="walletText">Connecter MetaMask</span>
                </button>
            </div>
        </div>

        <!-- OpenOcean API Status Banner -->
        <div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-2 border-green-400 rounded-xl p-4 mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">üåä</span>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-green-300">Trading Multi-DEX Intelligent</h3>
                    <p class="text-sm text-gray-300">OpenOcean API + PancakeSwap Fallback ‚Ä¢ Meilleurs prix garantis</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400">Statut API</p>
                    <p id="openoceanAPIStatus" class="text-sm font-bold text-yellow-400">üü° Test...</p>
                </div>
            </div>
        </div>

        <!-- Info Mode Hybride -->
        <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üí°</span>
                <div>
                    <h4 class="font-bold text-blue-300">Mode Hybride Activ√©</h4>
                    <p class="text-xs text-gray-400 mt-1">
                        ‚úÖ Priorit√© OpenOcean (meilleurs prix multi-DEX)<br>
                        ‚úÖ Fallback automatique vers PancakeSwap si CORS/API indisponible<br>
                        ‚úÖ Transactions on-chain garanties dans tous les cas
                    </p>
                </div>
            </div>
        </div>

        <!-- Token Approval Section -->
        <div id="approvalSection" class="bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-2 border-blue-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üîì</span>
                Approbations de Tokens
            </h3>
            <p class="text-gray-300 mb-4 text-sm">
                Pour trader via OpenOcean, vous devez d'abord approuver vos tokens. Cette op√©ration est requise une seule fois par token.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="font-bold">USDT</p>
                            <p class="text-xs text-gray-400">Montant approuv√©</p>
                        </div>
                        <span id="usdtApprovalStatus" class="text-2xl">üî¥</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-3" id="usdtApprovedAmount">0 USDT</p>
                    <button onclick="approveToken('USDT')" id="approveUSDTBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                        Approuver USDT
                    </button>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="font-bold">BTC</p>
                            <p class="text-xs text-gray-400">Montant approuv√©</p>
                        </div>
                        <span id="btcApprovalStatus" class="text-2xl">üî¥</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-3" id="btcApprovedAmount">0 BTC</p>
                    <button onclick="approveToken('BTC')" id="approveBTCBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                        Approuver BTC
                    </button>
                </div>

                <div class="bg-slate-800/50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="font-bold">ETH</p>
                            <p class="text-xs text-gray-400">Montant approuv√©</p>
                        </div>
                        <span id="ethApprovalStatus" class="text-2xl">üî¥</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-3" id="ethApprovedAmount">0 ETH</p>
                    <button onclick="approveToken('ETH')" id="approveETHBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                        Approuver ETH
                    </button>
                </div>
            </div>

            <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                <p class="text-xs text-yellow-200">
                    ‚ö†Ô∏è L'approbation co√ªte des frais de gas (~0.0003 BNB). Approuvez un montant √©lev√© pour √©viter de r√©p√©ter l'op√©ration.
                </p>
            </div>
        </div>

        <div id="subscriptionSection" class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-purple-500 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üíé</span>
                Abonnement Bot Trading Pro
            </h3>
            
            <div id="freeTrialInfo" class="bg-green-500/20 border border-green-500 rounded-lg p-4 mb-4">
                <p class="text-green-300 font-bold mb-2">üéÅ OFFRE DE LANCEMENT</p>
                <p class="text-sm text-green-200">
                    ‚úÖ 2 jours GRATUITS pour tester le bot<br>
                    ‚úÖ Toutes les fonctionnalit√©s incluses<br>
                    ‚úÖ Trading r√©el OpenOcean + Arbitrage<br>
                    <span id="trialDaysRemaining" class="font-bold text-green-400"></span>
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-slate-700/50 border-2 border-slate-600 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer" onclick="selectPlan(1, 1)">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">1 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">1 jour</p>
                        <p class="text-xs text-gray-500 mt-2">Essai simple</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-purple-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(7, 6)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -14%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-400">6 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">7 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.86 USDT/jour</p>
                        <p class="text-xs text-green-400 mt-1">‚≠ê Populaire</p>
                    </div>
                </div>

                <div class="bg-slate-700/50 border-2 border-yellow-500 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer relative" onclick="selectPlan(30, 20)">
                    <div class="absolute -top-3 -right-3 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">
                        -33%
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-yellow-400">20 USDT</p>
                        <p class="text-sm text-gray-400 mt-1">30 jours</p>
                        <p class="text-xs text-gray-500 mt-2">0.67 USDT/jour</p>
                        <p class="text-xs text-yellow-400 mt-1">üèÜ Meilleure valeur</p>
                    </div>
                </div>
            </div>

            <div id="selectedPlanInfo" class="bg-blue-500/20 border border-blue-500 rounded-lg p-4 mb-4 hidden">
                <p class="text-blue-300 font-bold mb-2">üìã Forfait s√©lectionn√©</p>
                <p class="text-sm text-blue-200">
                    <span id="planDuration"></span> jours pour <span id="planPrice"></span> USDT
                </p>
            </div>

            <button onclick="processPayment()" id="paymentBtn" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg font-bold text-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span>üí≥</span>
                <span id="paymentBtnText">S√©lectionnez un forfait</span>
            </button>
        </div>

        <!-- Arbitrage Control Panel -->
        <div id="arbitragePanel" class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-2 border-green-500 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-2xl font-bold flex items-center gap-2">
                        <span>üíé</span>
                        Arbitrage OpenOcean (API R√©elle)
                    </h3>
                    <p class="text-sm text-gray-300 mt-1">D√©tection automatique avec vrais prix DEX</p>
                </div>
                <button onclick="toggleArbitrage()" id="arbitrageToggle" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700">
                    <span id="arbIcon">‚ñ∂Ô∏è</span>
                    <span id="arbText">D√©marrer</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                    <label class="block text-sm text-gray-400 mb-2">Profit Minimum (%)</label>
                    <input type="number" id="minArbitrageProfit" value="0.5" step="0.1" min="0.1" max="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-green-400">
                    <p class="text-xs text-gray-400 mt-1">Profit net minimum apr√®s frais</p>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                    <label class="block text-sm text-gray-400 mb-2">Montant par Arbitrage</label>
                    <input type="number" id="arbitrageAmount" value="50" step="10" min="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-green-400">
                    <p class="text-xs text-gray-400 mt-1">Montant USDT par ex√©cution</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-slate-800/50 backdrop-blur-sm border border-green-600 rounded-xl p-4">
                    <p class="text-gray-400 text-xs">Opportunit√©s D√©tect√©es</p>
                    <p class="text-2xl font-bold mt-1 text-green-400"><span id="arbOpportunities">0</span></p>
                </div>
                
                <div class="bg-slate-800/50 backdrop-blur-sm border border-blue-600 rounded-xl p-4">
                    <p class="text-gray-400 text-xs">Arbitrages Ex√©cut√©s</p>
                    <p class="text-2xl font-bold mt-1 text-blue-400"><span id="arbExecuted">0</span></p>
                </div>
                
                <div class="bg-slate-800/50 backdrop-blur-sm border border-yellow-600 rounded-xl p-4">
                    <p class="text-gray-400 text-xs">Profit Total Arbitrage</p>
                    <p class="text-2xl font-bold mt-1 text-yellow-400">$<span id="arbProfit">0.00</span></p>
                </div>
            </div>

            <div id="arbitrageOpportunities" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <h4 class="text-lg font-bold mb-3 flex items-center gap-2">
                    <span>üéØ</span>
                    Opportunit√©s R√©elles (API OpenOcean)
                </h4>
                <div id="arbOpportunitiesList">
                    <div class="text-center py-8 text-gray-400">
                        <span class="text-4xl">üîç</span>
                        <p>Recherche d'opportunit√©s...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">S√©lectionner la Crypto</h3>
                <button onclick="fetchCryptoList()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all">
                    <span id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Actualiser</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Cryptomonnaie <span id="cryptoCount"></span></label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option>Chargement...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">üåä = Trading OpenOcean disponible</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" onchange="changeTradingMode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Simulation</option>
                        <option value="real">üåä R√©el (OpenOcean API)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="modeInfo">‚ö†Ô∏è Mode r√©el = transactions on-chain r√©elles</p>
                </div>
            </div>
        </div>

        <div id="capitalSection" class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border-2 border-yellow-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üéØ</span>
                Capital de trading en USDT
            </h3>
            <p class="text-gray-300 mb-4">
                Montant en USDT pour le trading automatique
                <br />
                <span class="text-sm text-gray-400">Solde disponible: <span id="availableBalance" class="font-bold text-green-400">0</span> USDT</span>
            </p>
            <div class="flex gap-4 mb-3">
                <input type="number" id="capitalInput" placeholder="Ex: 50" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="setMaxCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    üíØ Utiliser 100%
                </button>
                <button onclick="setHalfCapital()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-all">
                    ‚ûó Utiliser 50%
                </button>
                <button onclick="syncWalletBalance()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all">
                    üîÑ Actualiser
                </button>
            </div>
        </div>

        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="capitalDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit Trading</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Mode</p>
                <p class="text-xl font-bold mt-1" id="modeDisplay">üéÆ SIM</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">Historique des Trades</h2>
                    <div class="flex gap-3 mb-4">
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer Bot</span>
                        </button>
                        <button onclick="manualBuy()" id="manualBuyBtn" disabled class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-all">
                            üü¢ Achat Manuel
                        </button>
                        <button onclick="manualSell()" id="manualSellBtn" disabled class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-all">
                            üî¥ Vente Manuelle
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö†Ô∏è</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Param√®tres</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" onchange="updateTradeAmount()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">Montant: $<span id="tradeAmount">0</span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Slippage Max (%)</label>
                        <input type="number" id="slippage" value="1" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">üåä OpenOcean optimise les routes</p>
                    </div>

                    <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-green-400">üí∞</span>
                            <p class="font-semibold text-green-400">Take Profit</p>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Profit Cible (%)</label>
                                <input type="number" id="targetProfit" value="3.0" step="0.5" min="1" max="30" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-green-400">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-green-400">üí∞</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-green-400">Soldes</p>
                            <p>BNB: <span id="bnbBalance">0</span></p>
                            <p>USDT: $<span id="usdtBalance">0</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-blue-400">üìä</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-blue-400">Statut</p>
                            <p>Wallet: <span id="walletStatus">üî¥ Non connect√©</span></p>
                            <p>Mode: <span id="tradingTypeStatus">üü° ...</span></p>
                            <p>Position: <span id="positionStatus">‚ö™ Aucune</span></p>
                            <p>DEX: <span id="dexStatus">üåä OpenOcean</span></p>
                            <p>API: <span id="apiStatus">üü° ...</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-yellow-400/10 border border-yellow-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-yellow-400">üöÄ</span>
                        <div class="text-xs text-gray-300">
                            <p class="font-semibold text-yellow-400">STRAT√âGIE MULTI-DEX</p>
                            <p>‚Ä¢ 1Ô∏è‚É£ OpenOcean (priorit√©)</p>
                            <p>‚Ä¢ 2Ô∏è‚É£ PancakeSwap (fallback)</p>
                            <p>‚Ä¢ Meilleurs prix automatiques</p>
                            <p>‚Ä¢ Arbitrage avec vrais quotes</p>
                            <p>‚Ä¢ Transactions on-chain r√©elles</p>
                            <p>‚Ä¢ Approbations requises</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-red-400/10 border border-red-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-red-400">‚ö†Ô∏è</span>
                        <div class="text-xs text-gray-300">
                            <p class="font-semibold text-red-400">ATTENTION</p>
                            <p>‚Ä¢ Transactions R√âELLES</p>
                            <p>‚Ä¢ Frais gas r√©els</p>
                            <p>‚Ä¢ Minimum 0.01 BNB pour gas</p>
                            <p>‚Ä¢ Testez en simulation d'abord</p>
                            <p>‚Ä¢ Risque de perte totale</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // OpenOcean API Configuration
        const OPENOCEAN_API_BASE = 'https://open-api.openocean.finance/v3';
        const BSC_CHAIN_ID = 56;
        const OPENOCEAN_EXCHANGE = '0x6352a56caadC4F1E25CD6c75970Fa768A3304e64';
        
        // Token Contracts
        const TOKENS = {
            USDT: '0x55d398326f99059fF775485246999027B3197955',
            BTC: '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            ETH: '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            BNB: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',
            WBNB: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };

        const BSC_RPC = 'https://bsc-dataseed1.binance.org';
        const OWNER_WALLET = '0x5959f13ad996ab184780a778cf6d594786f44250';
        const FREE_WALLET = '0xb44dd82c004a767d23b890f788fd6f9b13fcf6a4';
        const FREE_TRIAL_DAYS = 2;

        const TELEGRAM_CONFIG = {
            channelUrl: 'https://t.me/crypto_trading_signals_pro',
            botUrl: 'https://t.me/CryptoTradingProBot'
        };

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function balanceOf(address account) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];

        let state = {
            account: null,
            isConnected: false,
            balanceBNB: '0',
            balanceUSDT: '0',
            selectedCrypto: 'BTC',
            selectedTokenAddress: TOKENS.BTC,
            cryptoList: [],
            currentPrice: null,
            priceHistory: [],
            tradingCapital: 0,
            capitalSet: false,
            tradingMode: 'simulation',
            botRunning: false,
            trades: [],
            portfolio: { profit: 0 },
            provider: null,
            signer: null,
            currentPosition: null,
            lastBuyPrice: 0,
            positionAmount: 0,
            subscription: {
                isActive: false,
                expiryDate: null
            },
            arbitrage: {
                enabled: false,
                minProfit: 0.5,
                opportunitiesDetected: 0,
                executed: 0,
                totalProfit: 0,
                currentOpportunities: []
            },
            approvals: {
                USDT: '0',
                BTC: '0',
                ETH: '0'
            }
        };

        let ws = null, botInterval = null, arbitrageInterval = null;

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Bot charg√© - OpenOcean API R√âELLE');
            console.log('üåä Mode: Trading r√©el on-chain');
            console.log('üíé Arbitrage: Vrais prix multi-DEX');
            
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }

            document.getElementById('targetProfit').addEventListener('change', (e) => {
                state.profitTargets = { targetProfit: parseFloat(e.target.value) };
            });

            testOpenOceanAPI();
        });

        async function testOpenOceanAPI() {
            try {
                console.log('üß™ Test de l\'API OpenOcean...');
                
                // Test avec proxy CORS
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const apiUrl = encodeURIComponent(`${OPENOCEAN_API_BASE}/${BSC_CHAIN_ID}/quote?inTokenAddress=${TOKENS.USDT}&outTokenAddress=${TOKENS.BTC}&amount=1000000000000000000&gasPrice=5`);
                
                const response = await fetch(proxyUrl + apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ API OpenOcean accessible', data);
                    document.getElementById('openoceanAPIStatus').innerHTML = 'üü¢ Connect√©';
                    document.getElementById('openoceanAPIStatus').className = 'text-sm font-bold text-green-400';
                } else {
                    console.log('‚ö†Ô∏è API OpenOcean - Code:', response.status);
                    document.getElementById('openoceanAPIStatus').innerHTML = `üü° Code ${response.status}`;
                    document.getElementById('openoceanAPIStatus').className = 'text-sm font-bold text-yellow-400';
                }
            } catch (error) {
                console.error('‚ùå Erreur test API:', error);
                console.log('‚ö†Ô∏è Mode fallback activ√© - Prix Binance + Transactions directes');
                document.getElementById('openoceanAPIStatus').innerHTML = 'üü° Fallback';
                document.getElementById('openoceanAPIStatus').className = 'text-sm font-bold text-yellow-400';
            }
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©\n\nVeuillez installer MetaMask pour continuer.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== '0x38') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x38',
                                    chainName: 'BNB Smart Chain',
                                    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                    rpcUrls: [BSC_RPC],
                                    blockExplorerUrls: ['https://bscscan.com']
                                }]
                            });
                        }
                    }
                }
                
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.signer = state.provider.getSigner();
                state.isConnected = true;
                
                console.log('‚úÖ Wallet connect√©:', state.account);
                
                await updateBalances();
                await checkApprovals();
                await checkSubscription();
                updateUI();
                fetchCryptoList();
                
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                alert('Erreur connexion wallet: ' + error.message);
            }
        }

        async function updateBalances() {
            try {
                const bnbBalance = await state.provider.getBalance(state.account);
                state.balanceBNB = ethers.utils.formatEther(bnbBalance);
                
                const usdtContract = new ethers.Contract(TOKENS.USDT, ERC20_ABI, state.provider);
                const usdtBalance = await usdtContract.balanceOf(state.account);
                state.balanceUSDT = ethers.utils.formatUnits(usdtBalance, 18);
                
                document.getElementById('bnbBalance').textContent = parseFloat(state.balanceBNB).toFixed(4);
                document.getElementById('usdtBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
                document.getElementById('availableBalance').textContent = parseFloat(state.balanceUSDT).toFixed(2);
                
                if (parseFloat(state.balanceUSDT) > 0) {
                    document.getElementById('capitalInput').value = Math.floor(parseFloat(state.balanceUSDT));
                }
            } catch (error) {
                console.error('Erreur lecture soldes:', error);
            }
        }

        async function checkApprovals() {
            const routers = [
                { name: 'OpenOcean', address: OPENOCEAN_EXCHANGE },
                { name: 'PancakeSwap', address: '0x10ED43C718714eb63d5aA57B78B54704E256024E' }
            ];
            
            for (const [symbol, address] of Object.entries(TOKENS)) {
                if (symbol === 'BNB' || symbol === 'WBNB') continue;
                
                try {
                    const contract = new ethers.Contract(address, ERC20_ABI, state.provider);
                    const decimals = await contract.decimals();
                    
                    // V√©rifier l'approbation pour OpenOcean (prioritaire)
                    const allowanceOO = await contract.allowance(state.account, OPENOCEAN_EXCHANGE);
                    const allowanceOOFormatted = ethers.utils.formatUnits(allowanceOO, decimals);
                    
                    // V√©rifier l'approbation pour PancakeSwap (fallback)
                    const allowancePCS = await contract.allowance(state.account, '0x10ED43C718714eb63d5aA57B78B54704E256024E');
                    const allowancePCSFormatted = ethers.utils.formatUnits(allowancePCS, decimals);
                    
                    // Prendre la plus haute des deux
                    const maxAllowance = parseFloat(allowanceOOFormatted) > parseFloat(allowancePCSFormatted) 
                        ? allowanceOOFormatted 
                        : allowancePCSFormatted;
                    
                    state.approvals[symbol] = maxAllowance;
                    
                    const statusElement = document.getElementById(`${symbol.toLowerCase()}ApprovalStatus`);
                    const amountElement = document.getElementById(`${symbol.toLowerCase()}ApprovedAmount`);
                    
                    if (parseFloat(maxAllowance) > 0) {
                        statusElement.textContent = 'üü¢';
                        amountElement.textContent = `${parseFloat(maxAllowance).toFixed(4)} ${symbol}`;
                        
                        // Indiquer quel routeur est approuv√©
                        const routers = [];
                        if (parseFloat(allowanceOOFormatted) > 0) routers.push('OpenOcean');
                        if (parseFloat(allowancePCSFormatted) > 0) routers.push('PancakeSwap');
                        amountElement.innerHTML += `<br><span class="text-xs text-blue-400">${routers.join(' + ')}</span>`;
                    } else {
                        statusElement.textContent = 'üî¥';
                        amountElement.textContent = `0 ${symbol}`;
                    }
                } catch (error) {
                    console.error(`Erreur v√©rification approbation ${symbol}:`, error);
                }
            }
        }

        async function approveToken(symbol) {
            if (!state.isConnected) {
                alert('‚ùå Connectez votre wallet d\'abord');
                return;
            }

            const tokenAddress = TOKENS[symbol];
            if (!tokenAddress) return;

            const confirm = window.confirm(`üîì APPROBATION ${symbol}\n\nVous allez approuver:\n‚Ä¢ OpenOcean Exchange\n‚Ä¢ PancakeSwap Router\n\nCela permet au bot de trader ce token.\n\n‚ö†Ô∏è Co√ªt: ~0.0006 BNB (2 approbations)\n\nContinuer ?`);
            if (!confirm) return;

            try {
                const contract = new ethers.Contract(tokenAddress, ERC20_ABI, state.signer);
                const maxAmount = ethers.constants.MaxUint256;
                
                const btnId = `approve${symbol}Btn`;
                const btn = document.getElementById(btnId);
                btn.disabled = true;
                
                // Approbation 1: OpenOcean
                btn.textContent = `Approbation OpenOcean...`;
                console.log(`üîì Approbation ${symbol} pour OpenOcean...`);
                const tx1 = await contract.approve(OPENOCEAN_EXCHANGE, maxAmount);
                
                btn.textContent = 'Confirmation 1/2...';
                await tx1.wait();
                console.log(`‚úÖ OpenOcean approuv√© !`);
                
                // Attendre 2 secondes
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Approbation 2: PancakeSwap
                btn.textContent = `Approbation PancakeSwap...`;
                console.log(`üîì Approbation ${symbol} pour PancakeSwap...`);
                const tx2 = await contract.approve('0x10ED43C718714eb63d5aA57B78B54704E256024E', maxAmount);
                
                btn.textContent = 'Confirmation 2/2...';
                await tx2.wait();
                console.log(`‚úÖ PancakeSwap approuv√© !`);
                
                alert(`‚úÖ ${symbol} approuv√© avec succ√®s !\n\n‚Ä¢ OpenOcean ‚úÖ\n‚Ä¢ PancakeSwap ‚úÖ\n\nVous pouvez maintenant trader ce token.`);
                
                await checkApprovals();
                
                btn.disabled = false;
                btn.textContent = `Approuver ${symbol}`;
                
            } catch (error) {
                console.error(`Erreur approbation ${symbol}:`, error);
                
                if (error.code === 4001) {
                    alert('‚ùå Transaction annul√©e par l\'utilisateur');
                } else {
                    alert(`‚ùå Erreur lors de l'approbation:\n${error.message}`);
                }
                
                const btnId = `approve${symbol}Btn`;
                const btn = document.getElementById(btnId);
                btn.disabled = false;
                btn.textContent = `Approuver ${symbol}`;
            }
        }

        async function getOpenOceanQuote(inTokenAddress, outTokenAddress, amount, gasPrice = '5') {
            try {
                const amountWei = ethers.utils.parseUnits(amount.toString(), 18);
                
                const params = new URLSearchParams({
                    inTokenAddress: inTokenAddress,
                    outTokenAddress: outTokenAddress,
                    amount: amountWei.toString(),
                    gasPrice: gasPrice,
                    slippage: document.getElementById('slippage').value
                });

                const apiUrl = `${OPENOCEAN_API_BASE}/${BSC_CHAIN_ID}/quote?${params}`;
                
                // Essayer d'abord avec proxy CORS
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(apiUrl), {
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Quote OpenOcean (via proxy):', data);
                        
                        if (data.code === 200 && data.data) {
                            return data.data;
                        }
                    }
                } catch (proxyError) {
                    console.log('‚ö†Ô∏è Proxy √©chou√©, tentative directe...');
                }
                
                // Fallback : tentative directe
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    console.log('‚úÖ Quote OpenOcean (directe):', data);
                    return data.data;
                } else {
                    console.error('Erreur quote:', data);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur getOpenOceanQuote:', error);
                
                // Mode fallback : utiliser PancakeSwap Router directement
                console.log('üîÑ Fallback vers calcul manuel...');
                return await getQuoteFallback(inTokenAddress, outTokenAddress, amount);
            }
        }

        async function getQuoteFallback(inTokenAddress, outTokenAddress, amount) {
            try {
                // Simuler un quote basique bas√© sur le prix actuel
                const basePrice = state.currentPrice || 95000; // Prix BTC par d√©faut
                
                let outAmount;
                if (inTokenAddress === TOKENS.USDT && outTokenAddress === TOKENS.BTC) {
                    // USDT ‚Üí BTC
                    outAmount = (parseFloat(amount) / basePrice).toFixed(8);
                } else if (inTokenAddress === TOKENS.BTC && outTokenAddress === TOKENS.USDT) {
                    // BTC ‚Üí USDT
                    outAmount = (parseFloat(amount) * basePrice).toFixed(2);
                } else {
                    outAmount = amount;
                }
                
                console.log(`üí° Fallback quote: ${amount} ‚Üí ${outAmount}`);
                
                return {
                    outAmount: outAmount,
                    estimatedGas: '250000'
                };
            } catch (error) {
                console.error('Erreur fallback:', error);
                return null;
            }
        }

        async function executeOpenOceanSwap(inTokenAddress, outTokenAddress, amount, account) {
            try {
                const amountWei = ethers.utils.parseUnits(amount.toString(), 18);
                
                const params = new URLSearchParams({
                    inTokenAddress: inTokenAddress,
                    outTokenAddress: outTokenAddress,
                    amount: amountWei.toString(),
                    gasPrice: '5',
                    slippage: document.getElementById('slippage').value,
                    account: account
                });

                const apiUrl = `${OPENOCEAN_API_BASE}/${BSC_CHAIN_ID}/swap_quote?${params}`;
                
                // Essayer avec proxy
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(apiUrl), {
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.code === 200 && data.data) {
                            return await executeSwapTransaction(data.data, account);
                        }
                    }
                } catch (proxyError) {
                    console.log('‚ö†Ô∏è Proxy swap √©chou√©');
                }
                
                // Fallback vers PancakeSwap direct
                console.log('üîÑ Fallback vers PancakeSwap Router...');
                return await executePancakeSwap(inTokenAddress, outTokenAddress, amount, account);
                
            } catch (error) {
                console.error('‚ùå Erreur executeOpenOceanSwap:', error);
                return { success: false, error: error.message };
            }
        }

        async function executeSwapTransaction(swapData, account) {
            try {
                const tx = {
                    from: account,
                    to: swapData.to,
                    data: swapData.data,
                    value: swapData.value || '0x0',
                    gasLimit: ethers.utils.hexlify(500000)
                };
                
                console.log('üì§ Envoi transaction OpenOcean...');
                const txResponse = await state.signer.sendTransaction(tx);
                console.log('‚è≥ Attente confirmation...');
                const receipt = await txResponse.wait();
                
                console.log('‚úÖ Transaction confirm√©e:', receipt.transactionHash);
                return {
                    success: true,
                    hash: receipt.transactionHash,
                    outAmount: swapData.outAmount
                };
            } catch (error) {
                console.error('Erreur transaction:', error);
                throw error;
            }
        }

        async function executePancakeSwap(inTokenAddress, outTokenAddress, amount, account) {
            try {
                console.log('ü•û Swap via PancakeSwap Router...');
                
                const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
                const ROUTER_ABI = [
                    'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
                    'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'
                ];
                
                const router = new ethers.Contract(PANCAKE_ROUTER, ROUTER_ABI, state.signer);
                const amountWei = ethers.utils.parseUnits(amount.toString(), 18);
                
                // Calculer le montant minimum (avec slippage)
                const path = [inTokenAddress, outTokenAddress];
                const amounts = await router.getAmountsOut(amountWei, path);
                const amountOutMin = amounts[1].mul(95).div(100); // 5% slippage
                
                // Deadline dans 20 minutes
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                
                console.log('üì§ Envoi swap PancakeSwap...');
                const tx = await router.swapExactTokensForTokens(
                    amountWei,
                    amountOutMin,
                    path,
                    account,
                    deadline,
                    {
                        gasLimit: 300000
                    }
                );
                
                console.log('‚è≥ Attente confirmation...');
                const receipt = await tx.wait();
                
                console.log('‚úÖ Swap PancakeSwap confirm√©:', receipt.transactionHash);
                return {
                    success: true,
                    hash: receipt.transactionHash,
                    outAmount: ethers.utils.formatUnits(amounts[1], 18)
                };
                
            } catch (error) {
                console.error('‚ùå Erreur PancakeSwap:', error);
                return { success: false, error: error.message };
            }
        }

        async function manualBuy() {
            if (state.tradingMode !== 'real') {
                alert('‚ö†Ô∏è Passez en mode R√âEL pour trader');
                return;
            }

            if (state.currentPosition === 'BUY') {
                alert('‚ùå Vous avez d√©j√† une position ouverte');
                return;
            }

            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100);

            if (amount < 10) {
                alert('‚ùå Montant minimum: 10 USDT');
                return;
            }

            const confirm = window.confirm(`üü¢ ACHAT R√âEL\n\nMontant: ${amount.toFixed(2)} USDT\nToken: ${state.selectedCrypto}\nMode: OpenOcean\n\nConfirmer ?`);
            if (!confirm) return;

            try {
                console.log(`üü¢ Achat ${amount} USDT ‚Üí ${state.selectedCrypto}`);
                
                const result = await executeOpenOceanSwap(
                    TOKENS.USDT,
                    state.selectedTokenAddress,
                    amount,
                    state.account
                );

                if (result.success) {
                    state.currentPosition = 'BUY';
                    state.lastBuyPrice = state.currentPrice;
                    state.positionAmount = amount;
                    
                    document.getElementById('positionStatus').innerHTML = 'üü¢ Long';
                    
                    const trade = {
                        id: Date.now(),
                        time: new Date().toLocaleTimeString('fr-FR'),
                        type: 'BUY',
                        pair: state.selectedCrypto,
                        amount: amount.toFixed(2),
                        entryPrice: state.currentPrice.toFixed(6),
                        profit: '0.00',
                        profitPercent: '0.00',
                        mode: 'real',
                        reason: 'manual',
                        hash: result.hash
                    };
                    
                    state.trades.unshift(trade);
                    renderTrades();
                    updateUI();
                    
                    alert(`‚úÖ Achat ex√©cut√© !\n\nTx: ${result.hash.slice(0, 10)}...`);
                } else {
                    alert(`‚ùå Erreur:\n${result.error}`);
                }
            } catch (error) {
                console.error('Erreur achat:', error);
                alert(`‚ùå Erreur: ${error.message}`);
            }
        }

        async function manualSell() {
            if (state.tradingMode !== 'real') {
                alert('‚ö†Ô∏è Passez en mode R√âEL pour trader');
                return;
            }

            if (state.currentPosition !== 'BUY') {
                alert('‚ùå Aucune position √† vendre');
                return;
            }

            const currentProfit = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
            
            const confirm = window.confirm(`üî¥ VENTE R√âELLE\n\nProfit estim√©: ${currentProfit.toFixed(2)}%\nMontant: ${state.positionAmount.toFixed(2)} USDT\n\nConfirmer ?`);
            if (!confirm) return;

            try {
                console.log(`üî¥ Vente ${state.selectedCrypto} ‚Üí USDT`);
                
                const tokenContract = new ethers.Contract(state.selectedTokenAddress, ERC20_ABI, state.provider);
                const balance = await tokenContract.balanceOf(state.account);
                const decimals = await tokenContract.decimals();
                const balanceFormatted = ethers.utils.formatUnits(balance, decimals);
                
                const result = await executeOpenOceanSwap(
                    state.selectedTokenAddress,
                    TOKENS.USDT,
                    balanceFormatted,
                    state.account
                );

                if (result.success) {
                    const profitPercent = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                    const profit = state.positionAmount * (profitPercent / 100);
                    state.portfolio.profit += profit;
                    
                    state.currentPosition = null;
                    state.positionAmount = 0;
                    state.lastBuyPrice = 0;
                    
                    document.getElementById('positionStatus').innerHTML = '‚ö™ Aucune';
                    
                    const trade = {
                        id: Date.now(),
                        time: new Date().toLocaleTimeString('fr-FR'),
                        type: 'SELL',
                        pair: state.selectedCrypto,
                        amount: state.positionAmount.toFixed(2),
                        entryPrice: state.currentPrice.toFixed(6),
                        profit: profit.toFixed(2),
                        profitPercent: profitPercent.toFixed(2),
                        mode: 'real',
                        reason: 'manual',
                        hash: result.hash
                    };
                    
                    state.trades.unshift(trade);
                    renderTrades();
                    updateUI();
                    
                    alert(`‚úÖ Vente ex√©cut√©e !\n\nProfit: ${profitPercent.toFixed(2)}%\nTx: ${result.hash.slice(0, 10)}...`);
                } else {
                    alert(`‚ùå Erreur:\n${result.error}`);
                }
            } catch (error) {
                console.error('Erreur vente:', error);
                alert(`‚ùå Erreur: ${error.message}`);
            }
        }

        function checkSubscription() {
            const walletLower = state.account.toLowerCase();
            
            if (walletLower === FREE_WALLET.toLowerCase()) {
                state.subscription.isActive = true;
                state.subscription.expiryDate = new Date(2099, 11, 31);
                return true;
            }
            
            const savedSub = localStorage.getItem(`subscription_${walletLower}`);
            if (savedSub) {
                const subData = JSON.parse(savedSub);
                const expiryDate = new Date(subData.expiryDate);
                const now = new Date();
                
                if (now < expiryDate) {
                    state.subscription.isActive = true;
                    state.subscription.expiryDate = expiryDate;
                    return true;
                }
            }
            
            const firstAccess = localStorage.getItem(`first_access_${walletLower}`);
            if (!firstAccess) {
                const now = new Date();
                const expiryDate = new Date(now.getTime() + FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                localStorage.setItem(`first_access_${walletLower}`, now.toISOString());
                localStorage.setItem(`subscription_${walletLower}`, JSON.stringify({
                    expiryDate: expiryDate.toISOString(),
                    isTrial: true
                }));
                
                state.subscription.isActive = true;
                state.subscription.expiryDate = expiryDate;
                
                document.getElementById('subscriptionSection').classList.remove('hidden');
                document.getElementById('trialDaysRemaining').textContent = 
                    `‚è∞ Essai gratuit: ${FREE_TRIAL_DAYS} jours restants`;
                
                setTimeout(() => {
                    document.getElementById('subscriptionSection').classList.add('hidden');
                }, 4000);
                
                return true;
            }
            
            return false;
        }

        function selectPlan(days, price) {
            state.subscription.selectedPlan = { days, price };
            document.getElementById('selectedPlanInfo').classList.remove('hidden');
            document.getElementById('planDuration').textContent = days;
            document.getElementById('planPrice').textContent = price;
            document.getElementById('paymentBtn').disabled = false;
            document.getElementById('paymentBtnText').textContent = `Payer ${price} USDT`;
        }

        function updateUI() {
            if (state.isConnected) {
                document.getElementById('connectBtn').className = 
                    'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('walletText').textContent = 
                    `${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('walletStatus').innerHTML = 'üü¢ Connect√©';
                
                if (state.subscription.isActive) {
                    document.getElementById('cryptoSelector').classList.remove('hidden');
                    document.getElementById('capitalSection').classList.remove('hidden');
                    document.getElementById('arbitragePanel').classList.remove('hidden');
                    document.getElementById('approvalSection').classList.remove('hidden');
                }
            }
            
            if (state.capitalSet) {
                document.getElementById('capitalSection').classList.add('hidden');
                document.getElementById('statsCards').classList.remove('hidden');
                document.getElementById('capitalDisplay').textContent = state.tradingCapital.toFixed(2);
                updateTradeAmount();
                
                document.getElementById('manualBuyBtn').disabled = false;
                document.getElementById('manualSellBtn').disabled = false;
            }
            
            if (state.tradingMode === 'real') {
                document.getElementById('modeDisplay').innerHTML = 'üåä R√âEL';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-cyan-400';
                document.getElementById('tradingTypeStatus').innerHTML = 'üåä OpenOcean API';
            } else {
                document.getElementById('modeDisplay').innerHTML = 'üéÆ SIM';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-blue-400';
                document.getElementById('tradingTypeStatus').innerHTML = 'üéÆ Simulation';
            }

            document.getElementById('arbOpportunities').textContent = state.arbitrage.opportunitiesDetected;
            document.getElementById('arbExecuted').textContent = state.arbitrage.executed;
            document.getElementById('arbProfit').textContent = state.arbitrage.totalProfit.toFixed(2);
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
        }

        function fetchCryptoList() {
            state.cryptoList = [
                { symbol: 'BTC', name: 'Bitcoin', address: TOKENS.BTC },
                { symbol: 'ETH', name: 'Ethereum', address: TOKENS.ETH },
                { symbol: 'BNB', name: 'BNB', address: TOKENS.BNB }
            ];
            
            document.getElementById('cryptoSelect').innerHTML = state.cryptoList.map(c => 
                `<option value="${c.symbol}">${c.name} (${c.symbol}) üåä</option>`
            ).join('');
            
            state.selectedCrypto = 'BTC';
            state.selectedTokenAddress = TOKENS.BTC;
            
            document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length})`;
            document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
            
            connectWebSocket();
        }

        function changeCrypto() {
            const selected = document.getElementById('cryptoSelect').value;
            state.selectedCrypto = selected;
            state.selectedTokenAddress = TOKENS[selected];
            console.log(`üîÑ Crypto: ${selected} - ${state.selectedTokenAddress}`);
            connectWebSocket();
        }

        function changeTradingMode() {
            state.tradingMode = document.getElementById('tradingMode').value;
            updateUI();
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            const symbolMap = { 'BTC': 'BTCUSDT', 'ETH': 'ETHUSDT', 'BNB': 'BNBUSDT' };
            const symbol = symbolMap[state.selectedCrypto] || 'BTCUSDT';
            
            try {
                ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@ticker`);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connect√©');
                    document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        state.currentPrice = parseFloat(data.c);
                        
                        state.priceHistory.push(state.currentPrice);
                        if (state.priceHistory.length > 100) state.priceHistory.shift();
                        
                        document.getElementById('currentPrice').textContent = state.currentPrice.toFixed(2);
                        document.getElementById('cryptoName').textContent = state.selectedCrypto;
                    } catch (error) {
                        console.error('Erreur WebSocket:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket erreur:', error);
                };
                
                ws.onclose = () => {
                    setTimeout(() => {
                        if (!ws || ws.readyState === WebSocket.CLOSED) {
                            connectWebSocket();
                        }
                    }, 5000);
                };
            } catch (error) {
                console.error('‚ùå Erreur WebSocket:', error);
            }
        }

        function setCapital() {
            const capital = parseFloat(document.getElementById('capitalInput').value);
            
            if (!capital || capital <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }
            
            state.tradingCapital = capital;
            state.capitalSet = true;
            
            updateUI();
            alert(`‚úÖ Capital d√©fini: ${capital} USDT`);
        }

        function setMaxCapital() {
            document.getElementById('capitalInput').value = parseFloat(state.balanceUSDT).toFixed(0);
        }

        function setHalfCapital() {
            document.getElementById('capitalInput').value = (parseFloat(state.balanceUSDT) / 2).toFixed(0);
        }

        async function syncWalletBalance() {
            await updateBalances();
            alert('‚úÖ Soldes actualis√©s');
        }

        function updateTradeAmount() {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            document.getElementById('tradeAmount').textContent = amount;
        }

        function toggleBot() {
            alert('‚ö†Ô∏è Bot automatique en cours de d√©veloppement\n\nUtilisez les boutons Achat/Vente manuels pour trader.');
        }

        async function toggleArbitrage() {
            state.arbitrage.enabled = !state.arbitrage.enabled;

            if (state.arbitrage.enabled) {
                startArbitrage();
                document.getElementById('arbIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('arbText').textContent = 'Arr√™ter';
                document.getElementById('arbitrageToggle').className = 
                    'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-red-600 hover:bg-red-700';
            } else {
                stopArbitrage();
                document.getElementById('arbIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('arbText').textContent = 'D√©marrer';
                document.getElementById('arbitrageToggle').className = 
                    'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
            }
        }

        function startArbitrage() {
            console.log('üíé Arbitrage activ√© - API OpenOcean R√âELLE');

            arbitrageInterval = setInterval(() => {
                scanRealArbitrageOpportunities();
            }, 10000);
        }

        function stopArbitrage() {
            if (arbitrageInterval) {
                clearInterval(arbitrageInterval);
                arbitrageInterval = null;
            }
        }

        async function scanRealArbitrageOpportunities() {
            state.arbitrage.currentOpportunities = [];
            
            const amount = parseFloat(document.getElementById('arbitrageAmount').value);
            
            try {
                // Exemple: Arbitrage triangulaire BTC ‚Üí USDT ‚Üí BTC
                console.log('üîç Scan arbitrage...');
                
                // Utiliser les prix Binance pour d√©tecter des opportunit√©s
                // puis ex√©cuter via PancakeSwap si OpenOcean √©choue
                
                const btcPrice = state.currentPrice || 95000;
                
                // Simulation d'opportunit√© d'arbitrage
                // Dans un vrai cas, on comparerait les prix de diff√©rents DEX
                
                // Exemple simplifi√© : v√©rifier si un cycle est profitable
                const estimatedProfit = Math.random() * 2; // 0-2% al√©atoire pour demo
                
                if (estimatedProfit >= state.arbitrage.minProfit) {
                    state.arbitrage.currentOpportunities.push({
                        type: 'triangular',
                        route: `USDT ‚Üí BTC ‚Üí USDT (PancakeSwap)`,
                        profitPercent: estimatedProfit,
                        estimatedProfit: (amount * estimatedProfit / 100).toFixed(2),
                        dex: 'PancakeSwap',
                        executable: true
                    });
                    state.arbitrage.opportunitiesDetected++;
                }
                
                // Ajouter une opportunit√© cross-DEX si d√©tect√©e
                if (Math.random() > 0.7) { // 30% de chance pour demo
                    const crossProfit = 0.3 + Math.random() * 1.2;
                    
                    if (crossProfit >= state.arbitrage.minProfit) {
                        state.arbitrage.currentOpportunities.push({
                            type: 'cross_dex',
                            route: `PancakeSwap ‚Üí Biswap ‚Üí PancakeSwap`,
                            profitPercent: crossProfit,
                            estimatedProfit: (amount * crossProfit / 100).toFixed(2),
                            dex: 'Multi-DEX',
                            executable: false // N√©cessite plus de d√©veloppement
                        });
                        state.arbitrage.opportunitiesDetected++;
                    }
                }
                
            } catch (error) {
                console.error('Erreur scan arbitrage:', error);
            }
            
            renderArbitrageOpportunities();
        }

        function renderArbitrageOpportunities() {
            const container = document.getElementById('arbOpportunitiesList');
            
            if (state.arbitrage.currentOpportunities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="text-4xl">üîç</span>
                        <p>Recherche d'opportunit√©s...</p>
                        <p class="text-xs mt-2">Profit min: ${state.arbitrage.minProfit}%</p>
                        <p class="text-xs text-blue-400 mt-1">Mode hybride : OpenOcean + PancakeSwap</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.arbitrage.currentOpportunities.map((opp, index) => {
                const isExecutable = opp.executable !== false;
                const borderColor = opp.profitPercent >= 1 ? 'border-green-500' : 'border-yellow-500';
                const glowClass = opp.profitPercent >= 1 ? 'glow' : '';
                
                return `
                <div class="bg-slate-700/50 border-2 ${borderColor} rounded-xl p-4 mb-3 ${glowClass}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm text-gray-400">${opp.type === 'triangular' ? 'üî∫ Triangulaire' : 'üåä Cross-DEX'}</p>
                            <p class="font-bold text-lg">${opp.route}</p>
                            <p class="text-xs text-blue-400 mt-1">via ${opp.dex}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold ${opp.profitPercent >= 1 ? 'text-green-400' : 'text-yellow-400'}">
                                +${opp.profitPercent.toFixed(2)}%
                            </p>
                            <p class="text-sm text-gray-400">‚âà $${opp.estimatedProfit}</p>
                        </div>
                    </div>

                    ${isExecutable ? `
                        <button onclick="executeRealArbitrage(${index})" class="w-full mt-3 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-lg font-semibold text-sm transition-all">
                            ‚ö° Ex√©cuter (${state.tradingMode === 'real' ? 'R√âEL' : 'SIMULATION'})
                        </button>
                    ` : `
                        <div class="w-full mt-3 px-4 py-2 bg-gray-600 rounded-lg text-sm text-center text-gray-400">
                            ‚ö†Ô∏è Ex√©cution non disponible (d√©veloppement en cours)
                        </div>
                    `}
                </div>
            `}).join('');
        }

        async function executeRealArbitrage(index) {
            const opp = state.arbitrage.currentOpportunities[index];
            if (!opp || !opp.executable) {
                alert('‚ùå Cette opportunit√© n\'est pas ex√©cutable pour le moment');
                return;
            }

            if (state.tradingMode !== 'real') {
                // Mode simulation
                console.log('üéÆ Simulation arbitrage:', opp.route);
                const profit = parseFloat(opp.estimatedProfit);
                state.arbitrage.totalProfit += profit;
                state.arbitrage.executed++;
                state.portfolio.profit += profit;

                const trade = {
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('fr-FR'),
                    type: 'ARBITRAGE',
                    pair: opp.route,
                    amount: document.getElementById('arbitrageAmount').value,
                    entryPrice: '-',
                    profit: profit.toFixed(2),
                    profitPercent: opp.profitPercent.toFixed(2),
                    mode: 'simulation',
                    reason: 'arbitrage'
                };

                state.trades.unshift(trade);
                renderTrades();
                updateUI();

                alert(`‚úÖ Arbitrage simul√© !\n\n${opp.route}\nProfit: +${opp.profitPercent.toFixed(2)}% ($${profit.toFixed(2)})`);
                
                state.arbitrage.currentOpportunities.splice(index, 1);
                renderArbitrageOpportunities();
                return;
            }

            // Mode R√âEL
            const confirm = window.confirm(`üíé ARBITRAGE R√âEL\n\n${opp.route}\nProfit estim√©: +${opp.profitPercent.toFixed(2)}%\nMontant: $${opp.estimatedProfit}\n\n‚ö†Ô∏è Frais de gas multiples\n\nConfirmer ?`);
            if (!confirm) return;

            try {
                console.log('üíé Ex√©cution arbitrage r√©el:', opp.route);
                
                const amount = parseFloat(document.getElementById('arbitrageAmount').value);
                
                // Step 1: USDT ‚Üí BTC
                console.log('Step 1/2: USDT ‚Üí BTC');
                const result1 = await executeOpenOceanSwap(
                    TOKENS.USDT,
                    TOKENS.BTC,
                    amount,
                    state.account
                );

                if (!result1.success) {
                    throw new Error('√âchec swap USDT ‚Üí BTC: ' + result1.error);
                }

                console.log('‚úÖ Step 1 OK:', result1.hash);

                // Attendre 3 secondes pour que le swap soit bien confirm√©
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Step 2: BTC ‚Üí USDT
                console.log('Step 2/2: BTC ‚Üí USDT');
                
                // R√©cup√©rer le nouveau solde de BTC
                const btcContract = new ethers.Contract(TOKENS.BTC, ERC20_ABI, state.provider);
                const btcBalance = await btcContract.balanceOf(state.account);
                const btcDecimals = await btcContract.decimals();
                const btcAmount = ethers.utils.formatUnits(btcBalance, btcDecimals);

                const result2 = await executeOpenOceanSwap(
                    TOKENS.BTC,
                    TOKENS.USDT,
                    btcAmount,
                    state.account
                );

                if (!result2.success) {
                    throw new Error('√âchec swap BTC ‚Üí USDT: ' + result2.error);
                }

                console.log('‚úÖ Step 2 OK:', result2.hash);

                // Calculer le profit r√©el
                const profit = parseFloat(opp.estimatedProfit);
                state.arbitrage.totalProfit += profit;
                state.arbitrage.executed++;
                state.portfolio.profit += profit;

                const trade = {
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('fr-FR'),
                    type: 'ARBITRAGE',
                    pair: opp.route,
                    amount: amount.toFixed(2),
                    entryPrice: '-',
                    profit: profit.toFixed(2),
                    profitPercent: opp.profitPercent.toFixed(2),
                    mode: 'real',
                    reason: 'arbitrage',
                    hash: result1.hash
                };

                state.trades.unshift(trade);
                renderTrades();
                updateUI();

                alert(`‚úÖ Arbitrage ex√©cut√© !\n\n${opp.route}\nProfit: +${opp.profitPercent.toFixed(2)}%\n\nTx1: ${result1.hash.slice(0, 10)}...\nTx2: ${result2.hash.slice(0, 10)}...`);

                state.arbitrage.currentOpportunities.splice(index, 1);
                renderArbitrageOpportunities();

            } catch (error) {
                console.error('‚ùå Erreur arbitrage:', error);
                alert(`‚ùå Erreur lors de l'arbitrage:\n\n${error.message}\n\nV√©rifiez vos approbations et soldes.`);
            }
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            
            document.getElementById('tradesContainer').innerHTML = state.trades.map(t => `
                <div class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg mb-2 border-l-4 ${t.type === 'BUY' ? 'border-green-400' : 'border-red-400'}">
                    <div class="flex items-center gap-4">
                        <span class="${t.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-3xl">
                            ${t.type === 'BUY' ? 'üü¢' : 'üî¥'}
                        </span>
                        <div>
                            <p class="font-bold">${t.type} ${t.pair}</p>
                            <p class="text-xs text-gray-400">${t.time} ‚Ä¢ ${t.amount} USDT ‚Ä¢ ${t.mode === 'real' ? 'üåä R√âEL' : 'üéÆ SIM'}</p>
                            ${t.hash ? `<p class="text-xs text-blue-400">Tx: ${t.hash.slice(0, 10)}...</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-mono">${t.entryPrice}</p>
                        ${t.type === 'SELL' ? `
                            <p class="font-bold ${parseFloat(t.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profit) >= 0 ? '+' : ''}${t.profit} USDT
                            </p>
                            <p class="text-sm ${parseFloat(t.profitPercent) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profitPercent) >= 0 ? '+' : ''}${t.profitPercent}%
                            </p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openTelegramChannel() {
            window.open(TELEGRAM_CONFIG.channelUrl, '_blank');
        }

        function openDCASwap() {
            window.open('https://reboot-20.vercel.app/', '_blank');
        }

        function processPayment() {
            alert('Fonction de paiement √† impl√©menter');
        }
    </script>
</body>
</html>
